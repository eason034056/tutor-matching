# 新家教案件郵件通知功能設置指南

## 功能介紹

這個功能會在有新的家教案件審核通過時，自動發送郵件通知給**已審核通過且願意接收通知**的教師，讓他們第一時間了解新的案件機會。

### 通知條件
- ✅ 教師必須已通過審核
- ✅ 教師必須同意接收新案件通知
- ✅ 教師必須有有效的email地址

## 系統架構

```
[管理員審核案件] → [獲取教師email列表] → [發送資料到n8n] → [批量發送郵件]
```

## 功能特點

✅ **自動化通知**：案件審核通過後自動發送  
✅ **批量處理**：一次通知所有符合條件的教師  
✅ **智能過濾**：自動過濾無效的email地址  
✅ **錯誤處理**：郵件發送失敗不影響案件審核流程  
✅ **重試機制**：失敗時會自動重試（最多3次）  
✅ **美觀郵件**：使用HTML格式的專業郵件模板  

## 設置步驟

### 1. n8n 工作流設置

已經自動創建了名為「新家教案件郵件通知」的n8n工作流，包含以下節點：

- **Webhook接收器**：接收案件資料和email列表
- **資料處理器**：處理和驗證email地址，準備郵件內容
- **Gmail發送器**：批量發送郵件給教師
- **回應節點**：返回發送結果

### 2. Gmail 設置

在n8n中需要配置Gmail節點：

1. 打開n8n控制台
2. 找到「新家教案件郵件通知」工作流
3. 點擊Gmail節點
4. 按照提示連接您的Gmail帳戶
5. 授權n8n存取您的Gmail

### 3. 環境變數配置

在您的環境中設置以下變數（可選）：

```bash
# n8n webhook URL（如果不是本地運行）
NEXT_PUBLIC_NEW_CASE_EMAIL_WEBHOOK_URL=http://localhost:5678/webhook/new-tutor-case

# 是否啟用webhook功能
NEXT_PUBLIC_ENABLE_WEBHOOKS=true
```

### 4. 測試功能

1. **註冊新教師時**：確認表單中有「接收新案件通知」的選項
2. **登入管理員後台**：可以看到每個教師的通知設定狀態
3. **審核通過一個家教案件**：系統會自動發送通知
4. **檢查控制台**：查看相關日誌是否正常
5. **確認教師們是否收到郵件通知**：只有同意接收通知的教師會收到

## 工作流程說明

### 資料流程

1. **教師註冊**：教師填寫表單時可選擇是否接收新案件通知（預設為是）
2. **管理員審核教師**：審核通過時會保留教師的通知設定
3. **管理員審核案件**：在管理員後台點擊「通過審核」
4. **獲取教師列表**：自動從Firebase的`approvedTutors`集合獲取**願意接收通知**的教師email
5. **過濾email**：移除無效或空的email地址
6. **發送到n8n**：將案件資料和email列表POST到n8n webhook
7. **處理郵件**：n8n處理資料並批量發送郵件
8. **回饋結果**：顯示發送成功或失敗的訊息

### 郵件內容

郵件會包含以下資訊：
- 案件編號
- 科目
- 時薪
- 上課地點
- 可上課時間
- 教師要求（如有）
- 學生狀況描述（如有）

## 錯誤處理

### 常見問題處理

1. **沒有教師email**：系統會靜默跳過，不影響案件審核
2. **webhook未啟用**：在開發環境中會跳過郵件發送
3. **網路錯誤**：會自動重試3次，使用指數退避策略
4. **Gmail配置錯誤**：會顯示錯誤訊息但不影響主流程

### 日誌監控

可以在以下地方查看相關日誌：
- 瀏覽器控制台：前端處理日誌
- n8n執行日誌：工作流執行詳情
- Gmail發送記錄：郵件發送狀態

## 自定義設置

### 修改郵件模板

編輯 `webhook-config.ts` 中的 `sendNewCaseEmailNotification` 函數內的郵件HTML模板。

### 調整重試設置

在 `webhook-config.ts` 中修改：
```typescript
// 最大重試次數
MAX_RETRIES: 3,

// 請求超時時間
WEBHOOK_TIMEOUT: 15000,
```

### 添加更多條件

可以在 `getApprovedTutorEmails` 函數中添加更多過濾條件，例如：
- 只通知特定科目的教師
- 排除已停用的教師
- 根據地區過濾

## 安全考量

1. **隱私保護**：email地址不會在前端暴露
2. **權限控制**：只有管理員可以觸發郵件通知
3. **資料驗證**：所有email都會進行格式驗證
4. **失敗隔離**：郵件發送失敗不影響核心業務流程

## 效能考量

- **資料量**：支援數百個教師email同時處理
- **併發控制**：n8n會按順序處理郵件發送
- **頻率限制**：Gmail API有每日發送限制，請注意用量

## 故障排除

### 檢查清單

- [ ] n8n工作流是否已啟動
- [ ] Gmail節點是否已正確配置
- [ ] 網路連接是否正常
- [ ] approvedTutors集合中是否有有效的email
- [ ] WEBHOOK_ENABLE是否設置正確

### 常見錯誤

1. **Connection refused**：檢查n8n是否在運行
2. **Gmail authentication failed**：重新授權Gmail連接
3. **No emails found**：檢查approvedTutors資料

## 維護建議

1. **定期檢查**：定期確認郵件發送是否正常
2. **監控用量**：注意Gmail API的使用量
3. **更新模板**：根據需求調整郵件內容
4. **備份設置**：定期備份n8n工作流配置

---

如有任何問題，請查看相關日誌或聯繫技術支援。 