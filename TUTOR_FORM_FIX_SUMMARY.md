# 教師註冊表單錯誤修復總結

## 🐛 原本的問題

### 1. 錯誤：「The string did not match the expected pattern」
**原因：** 表單驗證規則不夠嚴格

### 2. 錯誤：「Unexpected token 'R', "Request En"... is not valid JSON」
**原因：** 伺服器回傳的不是JSON格式，但程式試圖解析為JSON

---

## ✅ 已修復的問題

### 🔧 1. 加強表單驗證 (formSchema)

**修復項目：**
- **電話號碼驗證**：加入正則表達式檢查，只允許數字、空格、括號、加號和橫線
- **字元長度限制**：設定所有欄位的最大長度限制
- **圖片檔案檢查**：
  - 檔案大小不能超過5MB
  - 只允許JPG、PNG、WebP格式
  - 必須上傳檔案才能通過驗證

**程式碼範例：**
```typescript
phoneNumber: z.string()
  .min(10, { message: "請輸入有效的電話號碼（至少10位數字）" })
  .max(15, { message: "電話號碼不能超過15位數字" })
  .regex(/^[0-9-+\s()]*$/, { message: "電話號碼只能包含數字、空格、括號、加號和橫線" }),
```

### 🔧 2. 改善API錯誤處理

**修復項目：**
- **檢查Content-Type**：確認伺服器回應是否為JSON格式
- **分別處理JSON和非JSON錯誤**：避免「Unexpected token」錯誤
- **友善的錯誤訊息**：根據HTTP狀態碼提供具體的錯誤說明

**主要改善：**
```typescript
// 檢查回應的Content-Type是否為JSON
const contentType = response.headers.get('content-type')
if (contentType && contentType.includes('application/json')) {
  data = await response.json()
} else {
  // 如果不是JSON，讀取為純文字並拋出錯誤
  const errorText = await response.text()
  throw new Error('伺服器回應格式錯誤，請稍後再試')
}
```

### 🔧 3. 檔案上傳前的即時檢查

**新增功能：**
- **即時檔案大小檢查**：選擇檔案後立即檢查大小
- **檔案格式驗證**：確保只能上傳圖片格式
- **用戶反饋**：顯示檔案大小和上傳狀態

### 🔧 4. 詳細錯誤分類處理

**HTTP狀態碼對應：**
- **413**：檔案太大 → 「圖片檔案太大，請選擇小於5MB的圖片」
- **415**：格式不支援 → 「不支援的圖片格式，請選擇JPG、PNG或WebP格式」
- **500+**：伺服器錯誤 → 「伺服器暫時無法處理請求，請稍後再試」

---

## 🚀 使用說明（給用戶的指引）

### 📱 電話號碼格式
**正確格式：**
- `0912345678`
- `02-12345678`
- `+886-2-12345678`
- `(02) 1234-5678`

**錯誤格式：**
- 包含英文字母
- 包含特殊符號（除了 `-`、`+`、`()`、空格）

### 📧 電子郵件格式
**正確格式：**
- `user@example.com`
- `test.email@domain.com.tw`

### 📸 圖片上傳要求
**檔案格式：** JPG、PNG、WebP
**檔案大小：** 最大5MB
**必要性：** 學生證和身分證照片都必須上傳

### ⚠️ 常見錯誤處理
1. **檔案太大**：系統會立即提示，請壓縮圖片或選擇其他圖片
2. **網路問題**：會顯示「請稍後再試」，請檢查網路連線
3. **伺服器忙碌**：系統會自動重試，或請稍後重新提交

---

## 🔍 開發者注意事項

### 新增的錯誤檢查
1. **Content-Type檢查**：避免JSON解析錯誤
2. **檔案大小即時檢查**：提升用戶體驗
3. **詳細錯誤記錄**：便於除錯

### 可能需要的後續改善
1. **伺服器端**：確保所有API都回傳正確的Content-Type
2. **圖片壓縮**：可考慮在前端自動壓縮大型圖片
3. **重試機制**：可以加入自動重試失敗的上傳

---

這些修復應該能解決用戶遇到的兩個主要錯誤，並提供更好的用戶體驗！
